<!DOCTYPE html>
<html>
<body>
<video autoplay playsinline style="width:100%;height:100%"></video>

<script>
if (!sessionStorage.getItem("auth")) {
  location.href = "/login.html";
}

const ws = new WebSocket(location.origin.replace("http", "ws"));
const pc = new RTCPeerConnection();
const video = document.querySelector("video");

pc.ontrack = e => video.srcObject = e.streams[0];

ws.onopen = () => ws.send(JSON.stringify({ type: "viewer" }));

ws.onmessage = async e => {
  const msg = JSON.parse(e.data);

  if (msg.offer) {
    await pc.setRemoteDescription(msg.offer);
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    ws.send(JSON.stringify({ type: "signal", answer }));
  }

  if (msg.candidate) {
    await pc.addIceCandidate(msg.candidate);
  }
};
</script>
</body>
</html>
